# Slack Botä»•æ§˜æ›¸

## 1. ãƒãƒ£ãƒ³ãƒãƒ«æ§‹æˆ

| ãƒãƒ£ãƒ³ãƒãƒ« | å‘½åè¦å‰‡ | ç”¨é€” | ä½œæˆã‚¿ã‚¤ãƒŸãƒ³ã‚° |
|-----------|----------|------|---------------|
| `#oncall-night` | å›ºå®šå | å¤œé–“ã‚ªãƒ³ã‚³ãƒ¼ãƒ«ã€‚æœ8æ™‚å®šæ™‚ãƒ¬ãƒãƒ¼ãƒˆ | åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ |
| `#pt-{æ‚£è€…å}` | `pt-` + æ‚£è€…åã®ç©ºç™½é™¤å» | æ‚£è€…ã”ã¨ã®æƒ…å ±è“„ç©ãƒ»AIå¯¾è©±ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ | Admin UIæ‚£è€…ç™»éŒ²æ™‚ |

## 2. Botæ¨©é™ï¼ˆOAuth Scopesï¼‰

```
channels:manage      # ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ
channels:read        # ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±å–å¾—
channels:join        # Botã®ãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ 
chat:write           # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ•ç¨¿
groups:write         # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«æ“ä½œ
groups:read          # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±å–å¾—
users:read           # ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±å–å¾—
files:read           # æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Š
app_mentions:read    # @bot ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ¤œçŸ¥
```

## 3. Events APIè¨­å®š

### 3.1 Subscribe Events

| Event | ç”¨é€” |
|-------|------|
| `message.channels` | ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ |
| `message.groups` | ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ |
| `app_mention` | @bot ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å—ä¿¡ |

### 3.2 Request URL

`https://homecare-bot-xxx.run.app/slack/events`

### 3.3 ç½²åæ¤œè¨¼

ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ `X-Slack-Signature` ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ `X-Slack-Request-Timestamp` ã‚’ä½¿ç”¨ã—ã¦HMAC-SHA256ç½²åã‚’æ¤œè¨¼ã€‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®è¨±å®¹å·®ã¯5åˆ†ä»¥å†…ã€‚

```python
import hashlib, hmac, time

def verify_slack_signature(signing_secret, timestamp, body, signature):
    if abs(time.time() - int(timestamp)) > 300:
        return False
    sig_basestring = f"v0:{timestamp}:{body}"
    my_signature = "v0=" + hmac.new(
        signing_secret.encode(), sig_basestring.encode(), hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(my_signature, signature)
```

## 4. ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«

### 4.1 3ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³

| ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | Botã®æŒ™å‹• | ãƒ‡ãƒ¼ã‚¿ä¿å­˜ |
|-------------------|----------|-----------|
| ãƒãƒ£ãƒ³ãƒãƒ«ã«ç›´æ¥æŠ•ç¨¿ | **ç„¡åå¿œ**ï¼ˆç›£è¦–ã—ãªã„ï¼‰ | ä¿å­˜ã—ãªã„ |
| Botã‚¢ãƒ³ã‚«ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒªãƒ—ãƒ©ã‚¤ | Intake Agentèµ·å‹• â†’ BPSæ§‹é€ åŒ– â†’ ç¢ºèªå¿œç­” | **ä¿å­˜ã™ã‚‹** |
| `@bot` ã§è³ªå•/ã‚³ãƒãƒ³ãƒ‰ | Context/Summary Agent â†’ å›ç­” | ä¿å­˜ã—ãªã„ |

### 4.2 ã‚¤ãƒ™ãƒ³ãƒˆåˆ¤å®šãƒ•ãƒ­ãƒ¼

```python
def handle_event(event):
    # 1. Botè‡ªèº«ã®æŠ•ç¨¿ã¯ç„¡è¦–
    if event.get("bot_id"):
        return

    channel_id = event["channel"]
    patient = find_patient_by_channel(channel_id)
    if not patient:
        return  # æ‚£è€…ãƒãƒ£ãƒ³ãƒãƒ«ã§ãªã„å ´åˆã¯ç„¡è¦–

    # 2. @bot ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³
    if event["type"] == "app_mention":
        text = event["text"]
        if "ã‚µãƒãƒªãƒ¼" in text or "çµŒé" in text or "å¼•ãç¶™ã" in text:
            return summary_agent.run(patient, text)
        elif "ä¿å­˜" in text:
            return intake_agent.run_save_mode(patient, channel_id)
        else:
            return context_agent.run(patient, text)

    # 3. ã‚¢ãƒ³ã‚«ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸ã®ãƒªãƒ—ãƒ©ã‚¤åˆ¤å®š
    if event.get("thread_ts") == patient.slack_anchor_message_ts:
        return intake_agent.run(patient, event)

    # 4. ãã‚Œä»¥å¤–ï¼ˆç›´æ¥æŠ•ç¨¿ï¼‰â†’ ç„¡è¦–
    return
```

### 4.3 æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†

```python
def process_attachments(event, patient):
    files = event.get("files", [])
    for file in files:
        if file["mimetype"] == "application/pdf":
            # PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â†’ GCSä¿å­˜ â†’ ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º
            content = download_and_extract_pdf(file)
        elif file["mimetype"].startswith("image/"):
            # ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â†’ GCSä¿å­˜ â†’ Gemini Vision
            content = download_and_extract_image(file)
        else:
            continue

        # BPSæ§‹é€ åŒ–
        return intake_agent.run_with_content(patient, content, file)
```

## 5. ã‚¢ãƒ³ã‚«ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»•æ§˜

æ‚£è€…ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆæ™‚ã«BotãŒè‡ªå‹•æŠ•ç¨¿ã™ã‚‹åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‚

```
ğŸ“‹ {æ‚£è€…å}ã•ã‚“ï¼ˆ{å¹´é½¢}æ­³ãƒ»{æ€§åˆ¥}ï¼‰ã®ãƒãƒ£ãƒ³ãƒãƒ«ã§ã™ã€‚

ğŸ“Œ ä½¿ã„æ–¹:
â€¢ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒªãƒ—ãƒ©ã‚¤ â†’ æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¾ã™ï¼ˆãƒ†ã‚­ã‚¹ãƒˆ/PDF/ç”»åƒï¼‰
â€¢ @HomeCare AI + è³ªå• â†’ AIãŒæ‚£è€…ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åŸºã¥ã„ã¦å›ç­”ã—ã¾ã™
â€¢ ãƒãƒ£ãƒ³ãƒãƒ«ã«ç›´æ¥æŠ•ç¨¿ â†’ ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼ˆãƒãƒ¼ãƒ å†…ã®ä¼šè©±ç”¨ï¼‰

ğŸ·ï¸ {åŸºç¤ç–¾æ‚£ãƒªã‚¹ãƒˆ}
ğŸ¥ {äº‹æ¥­æ‰€} | ğŸ“ {åœ°åŒº}
```

ãƒãƒ£ãƒ³ãƒãƒ«ãƒˆãƒ”ãƒƒã‚¯:
```
{æ‚£è€…å}ï¼ˆ{å¹´é½¢}æ­³ãƒ»{æ€§åˆ¥}ï¼‰| {åŸºç¤ç–¾æ‚£} | {äº‹æ¥­æ‰€} | {åœ°åŒº}
```

## 6. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé›†

### 6.1 å ±å‘Šç¢ºèªå¿œç­”

```
âœ… ä¿å­˜ã—ã¾ã—ãŸ

Bio: SpO2 94%(â†“2pt/1w), é£Ÿæ¬²ä½ä¸‹
Psycho: è¡¨æƒ…æš—ã„ã€æ„æ¬²ä½ä¸‹ã®å¯èƒ½æ€§
Social: -

ğŸ“Š ç¢ºä¿¡åº¦: 0.92 | å ±å‘Šè€…: çœ‹è­·å¸«A | ã‚½ãƒ¼ã‚¹: ãƒ†ã‚­ã‚¹ãƒˆ
```

### 6.2 ã‚¢ãƒ©ãƒ¼ãƒˆæŠ•ç¨¿

```
âš ï¸ è¤‡åˆçš„æ‚ªåŒ–å¾´å€™ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸ

ğŸ«€ Bio: SpO2ä½ä¸‹ãƒˆãƒ¬ãƒ³ãƒ‰(96%â†’94%/1w) + é£Ÿæ¬²ä½ä¸‹
ğŸ§  Psycho: æ„æ¬²ä½ä¸‹ã®å¯èƒ½æ€§
ğŸ’Š æœè–¬: é™åœ§è–¬ã‚¢ãƒ‰ãƒ’ã‚¢ãƒ©ãƒ³ã‚¹ä½ä¸‹(é€±2å›å¿˜ã‚Œ)

ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:
â€¢ å‘¼å¸å™¨æ„ŸæŸ“ç—‡ãƒ»å¿ƒä¸å…¨å¢—æ‚ªã®é™¤å¤–æ¤œæŸ»ã‚’æ¤œè¨
â€¢ ä¸»æ²»åŒ»ã¸ã®æ—©æœŸç›¸è«‡ã‚’æ¨å¥¨

ğŸ“ æ ¹æ‹ : çœ‹è­·å¸«A(2/3 14:30), è–¬å‰¤å¸«B(2/4 10:15)
```

### 6.3 BPSã‚µãƒãƒªãƒ¼

```
ğŸ“‹ ç”°ä¸­å¤ªéƒã•ã‚“ BPSã‚µãƒãƒªãƒ¼ï¼ˆ2026-02-05æ™‚ç‚¹ï¼‰

ğŸ«€ Biological
â€¢ SpO2: 94%(â†“2pt/1w) â€” è¦çµŒéè¦³å¯Ÿ
â€¢ é£Ÿæ¬²: ä½ä¸‹ï¼ˆ2/3ã€œï¼‰
â€¢ æœè–¬: é™åœ§è–¬ã‚¢ãƒ‰ãƒ’ã‚¢ãƒ©ãƒ³ã‚¹ä½ä¸‹ï¼ˆé€±2å›å¿˜ã‚Œï¼‰
â€¢ BP 148/92 å®‰å®šã€HbA1c 7.2%(â†‘0.3/3m)

ğŸ§  Psychological
â€¢ è¡¨æƒ…æš—ã„ã€æ„æ¬²ä½ä¸‹å‚¾å‘
â€¢ èªçŸ¥å¤‰åŒ–ã®å¯èƒ½æ€§ï¼ˆå®¶æ—å ±å‘Šã‚ã‚Šï¼‰

ğŸ‘¥ Social
â€¢ å¦»(82æ­³)ã¨äºŒäººæš®ã‚‰ã—ã€‚ä»‹è­·è² æ‹…å¢—åŠ å‚¾å‘
â€¢ è¨ªçœ‹é€±2å›ã€ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹é€±1å›

âš ï¸ æ³¨æ„ç‚¹
â€¢ SpO2ä½ä¸‹+é£Ÿæ¬²ä½ä¸‹ â†’ å‘¼å¸å™¨æ„ŸæŸ“ç—‡/å¿ƒä¸å…¨å¢—æ‚ªã®é™¤å¤–ã‚’æ¨å¥¨
â€¢ èªçŸ¥å¤‰åŒ–+æœè–¬ä½ä¸‹ â†’ èªçŸ¥æ©Ÿèƒ½è©•ä¾¡ãƒ»æœè–¬ç®¡ç†æ–¹æ³•è¦‹ç›´ã—ã‚’æ¤œè¨
```

### 6.4 æœ8æ™‚å®šæ™‚ãƒ¬ãƒãƒ¼ãƒˆï¼ˆ#oncall-nightï¼‰

```
ğŸ“Š æœãƒ¬ãƒãƒ¼ãƒˆ | 2026-02-05ï¼ˆæ°´ï¼‰

çŠ¶æ…‹å¤‰åŒ–: 5å / å…¨24å

ğŸ”´ HIGH (2å)
â€¢ ç”°ä¸­å¤ªéƒ(85æ­³) - SpO2ä½ä¸‹+é£Ÿæ¬²ä½ä¸‹+æœè–¬ä½ä¸‹+èªçŸ¥å¤‰åŒ– â†’ #pt-ç”°ä¸­å¤ªéƒ
â€¢ æ‘ä¸Šãƒˆãƒ¡(96æ­³) - è¤¥ç˜¡æ‚ªåŒ–+å¿ƒä¸å…¨å¢—æ‚ªå¾´å€™ â†’ #pt-æ‘ä¸Šãƒˆãƒ¡

ğŸŸ¡ MED (3å)
â€¢ ä½è—¤ç¾æ™ºå­(78æ­³) - è¡€ç³–ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ‚ªåŒ– â†’ #pt-ä½è—¤ç¾æ™ºå­
â€¢ å¾Œè—¤å®Ÿ(73æ­³) - è…¹æ°´å¢—åŠ å‚¾å‘ â†’ #pt-å¾Œè—¤å®Ÿ
â€¢ æ—èª (92æ­³) - å¿ƒä¸å…¨ç—‡çŠ¶å¾®å¢— â†’ #pt-æ—èª 

ğŸŸ¢ å¤‰åŒ–ãªã—: 19å
```

### 6.5 Context Agentå›ç­”ä¾‹

```
ğŸ’¬ ç”°ä¸­å¤ªéƒã•ã‚“ã«ã¤ã„ã¦ãŠç­”ãˆã—ã¾ã™ã€‚

ç›´è¿‘1é€±é–“ã®BPSãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã¨:

ğŸ«€ SpO2ã¯2/3ã®è¨ªå•æ™‚ã«94%ã§ã€1é€±é–“å‰ã®96%ã‹ã‚‰ä½ä¸‹å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚
é£Ÿæ¬²ä½ä¸‹ã‚‚2/3ã‹ã‚‰å ±å‘Šã•ã‚Œã¦ãŠã‚Šã€COPDæ€¥æ€§å¢—æ‚ªã®åˆæœŸæ®µéšã®å¯èƒ½æ€§ã‚’
è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ğŸ’Š è–¬å‰¤å¸«Bã•ã‚“ã®å ±å‘Š(2/4)ã§ã¯é™åœ§è–¬ã®ã‚¢ãƒ‰ãƒ’ã‚¢ãƒ©ãƒ³ã‚¹ä½ä¸‹ãŒæŒ‡æ‘˜ã•ã‚Œã¦
ãŠã‚Šã€èªçŸ¥å¤‰åŒ–ã¨ã®é–¢é€£ã‚‚æ¤œè¨ã™ã¹ãã§ã™ã€‚

ğŸ“‹ æ¨å¥¨:
â€¢ å‘¼å¸å™¨æ„ŸæŸ“ç—‡ãƒ»å¿ƒä¸å…¨å¢—æ‚ªã®é™¤å¤–ï¼ˆèƒ¸éƒ¨Xç·šã€BNPç­‰ï¼‰
â€¢ èªçŸ¥æ©Ÿèƒ½ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆMMSE or HDS-Rï¼‰
â€¢ æœè–¬ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å°å…¥æ¤œè¨

ğŸ“ å‚ç…§: çœ‹è­·å¸«A(2/3), è–¬å‰¤å¸«B(2/4), ã”å®¶æ—(2/1)
```

## 7. Slack APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨ä¸€è¦§

| ç”¨é€” | API ãƒ¡ã‚½ãƒƒãƒ‰ | å‘¼ã³å‡ºã—å…ƒ |
|------|-------------|-----------|
| ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ | `conversations.create` | æ‚£è€…ç™»éŒ²API |
| Botãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ  | `conversations.join` | æ‚£è€…ç™»éŒ²API |
| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ•ç¨¿ | `chat.postMessage` | å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ |
| ã‚¹ãƒ¬ãƒƒãƒ‰ãƒªãƒ—ãƒ©ã‚¤ | `chat.postMessage` (thread_tsä»˜ã) | Intake/Context/Summary |
| ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾… | `conversations.invite` | æ‚£è€…ç™»éŒ²API |
| ãƒˆãƒ”ãƒƒã‚¯è¨­å®š | `conversations.setTopic` | æ‚£è€…ç™»éŒ²/ç·¨é›†API |
| ãƒãƒ£ãƒ³ãƒãƒ«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– | `conversations.archive` | æ‚£è€…ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–API |
| ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ | `files.info` + URLå–å¾— | Intake Agent |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾— | `users.info` | reporter_nameè§£æ±º |
| æ¥ç¶šãƒ†ã‚¹ãƒˆ | `auth.test` | ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ |

## 8. Slack Appãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ

Admin UIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã§ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ç”¨ã™ã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆJSON:

```json
{
  "display_information": {
    "name": "HomeCare AI",
    "description": "åœ¨å®…åŒ»ç™‚æ”¯æ´AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ",
    "background_color": "#4ecdc4"
  },
  "features": {
    "bot_user": {
      "display_name": "HomeCare AI",
      "always_online": true
    }
  },
  "oauth_config": {
    "scopes": {
      "bot": [
        "channels:manage",
        "channels:read",
        "channels:join",
        "chat:write",
        "groups:write",
        "groups:read",
        "users:read",
        "files:read",
        "app_mentions:read"
      ]
    }
  },
  "settings": {
    "event_subscriptions": {
      "request_url": "{CLOUD_RUN_URL}/slack/events",
      "bot_events": [
        "message.channels",
        "message.groups",
        "app_mention"
      ]
    },
    "org_deploy_enabled": false,
    "socket_mode_enabled": false
  }
}
```
