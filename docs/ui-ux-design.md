# UI/UX設計書

## 1. 画面一覧（全14ルート + モーダル）

| # | 画面名 | ルート / 表示方式 | グループ | 状態 |
|---|--------|-----------------|---------|------|
| 1 | ログイン | `/login` Full Page | 認証 | ✅ |
| 2 | 初期セットアップウィザード | `/setup` Full Page | 認証 | ✅ |
| 3 | ダッシュボード | `/` Sidebar + Main | メイン | ✅ |
| 4 | 患者一覧 | `/patients` Sidebar + Main | 患者管理 | ✅ |
| 5 | 患者新規登録 | `/patients/new` Full Page | 患者管理 | ✅ |
| 6 | CSVインポート | `/patients/import` Full Page | 患者管理 | ✅ |
| 7 | 患者詳細 | `/patients/[id]` Sidebar + Main (Drill-down) | 患者管理 | ✅ |
| 8 | 患者情報編集 | `/patients/[id]/edit` Full Page | 患者管理 | ✅ |
| 9 | アラート一覧 | `/alerts` Sidebar + Main | アラート | ✅ |
| 10 | ナレッジベース | `/knowledge` Sidebar + Main | AI設定 | ✅ |
| 11 | API & サービス設定 | `/settings/api` Sidebar + Main | システム設定 | ✅ |
| 12 | マスタ管理 | `/settings/master` Sidebar + Main | システム設定 | ✅ |
| 13 | 組織設定 | `/settings/organization` Sidebar + Main | システム設定 | ✅ |
| 14 | AIエージェント設定 | `/settings/agents` Sidebar + Main | AI設定 | ✅ |

**ページ内モーダル:**
- BulkAssignMembersModal（患者一覧内 — 一括メンバー割当）
- ExportModal（患者詳細内 — エクスポート）
- DeletePatientModal（患者詳細内 — 患者削除確認）
- ナレッジ追加モーダル（ナレッジベース内）
- アラート詳細（アラート一覧内インライン展開）

## 2. 画面遷移図

```
[ログイン /login]
  ├─ 初回 → [セットアップウィザード /setup] → [ダッシュボード /]
  └─ 認証済み → [ダッシュボード /]

[ダッシュボード /]（※サイドバーから全画面にアクセス可能）
  ├─ アラートカード → [患者詳細 /patients/[id]]
  ├─ 接続異常 → [API設定 /settings/api]
  └─ サイドバー → 全画面

[患者一覧 /patients]
  ├─ ＋新規 → [患者登録 /patients/new] (独立ページ)
  ├─ CSVインポート → [インポート /patients/import] (独立ページ)
  ├─ 一括メンバー割当 → [BulkAssignMembersModal] (モーダル)
  └─ 行クリック → [患者詳細 /patients/[id]]
      ├─ 編集 → [患者編集 /patients/[id]/edit] (独立ページ)
      ├─ エクスポート → [ExportModal] (モーダル)
      └─ 削除 → [DeletePatientModal] (モーダル)

[アラート一覧 /alerts]
  └─ カード展開 → アラート詳細（インライン展開）
      └─ 患者を見る → [患者詳細 /patients/[id]]

[ナレッジベース /knowledge]
  ├─ ＋追加 → ナレッジ追加（ページ内モーダル）
  └─ 検索テストタブ → インラインテスト

[設定]
  ├─ [API設定 /settings/api]
  ├─ [マスタ管理 /settings/master]
  ├─ [組織設定 /settings/organization]
  └─ [AIエージェント設定 /settings/agents]
```

## 3. レイアウトパターン

### 3.1 Full Page（認証画面）

サイドバーなし。画面中央にコンテンツ。ログインとセットアップウィザードに使用。

```
┌──────────────────────────────────────┐
│                                      │
│           [ロゴ + タイトル]            │
│                                      │
│           [メインコンテンツ]           │
│                                      │
└──────────────────────────────────────┘
```

### 3.2 Sidebar + Main（通常画面）

左固定サイドバー（w-56, 224px）+ 右メインエリア。

```
┌────────┬─────────────────────────────┐
│        │ [ヘッダー: ページタイトル]     │
│ サイド  │                              │
│ バー    │ [メインコンテンツ]            │
│        │                              │
│ (固定)  │                              │
│        │                              │
│ [ユーザー]                             │
└────────┴─────────────────────────────┘
```

### 3.3 Modal Overlay（登録・編集・詳細）

親画面の上にオーバーレイ。背景暗転。max-w-lg or max-w-2xl。

### 3.4 Drill-down（患者詳細）

パンくずリスト付き。「患者一覧 > 田中太郎」形式。

## 4. サイドバー設計

```
┌──────────────────────┐
│ 🏥 HomeCare AI        │  ← ロゴ + アプリ名
├──────────────────────┤
│ 📊 ダッシュボード      │  ← メイン
├──────────────────────┤
│ 患者管理              │  ← セクションラベル
│  👥 患者一覧          │
│  ➕ 患者登録     [+]  │  ← アクションボタン
├──────────────────────┤
│ モニタリング          │
│  ⚠️ アラート     [3]  │  ← バッジ（未確認数）
├──────────────────────┤
│ AI設定               │
│  🧠 ナレッジベース     │
├──────────────────────┤
│ システム設定          │
│  🔑 API & サービス    │
│  🏢 マスタ管理        │
│  🏥 組織設定          │
├──────────────────────┤
│ 👤 管理者             │  ← ユーザー情報
│    admin@clinic.jp    │
│    [ログアウト]        │
└──────────────────────┘
```

## 5. 各画面仕様

### 5.1 ログイン画面

- Firebase Authentication（メール+パスワード / Google Sign-In）
- ロゴ + アプリ名「HomeCare AI」
- メールアドレス入力 + パスワード入力 + ログインボタン
- Googleログインボタン
- 初回ログイン判定: Firestoreに `organizations` ドキュメントが存在しなければセットアップへ

### 5.2 セットアップウィザード（初回のみ）

4ステップのウィザード形式。プログレスバー付き。

**Step 1: Slack App作成ガイド**
- 手順を4ステップで明示
- マニフェストJSONのコピーボタン
- api.slack.com/apps へのリンクボタン

**Step 2: トークン入力**
- Bot User OAuth Token（`xoxb-` バリデーション）
- Signing Secret（32文字英数字バリデーション）
- 組織名（必須テキスト入力）

**Step 3: 接続テスト**
- 「接続テスト」ボタン → Slack auth.test API呼び出し
- 成功: ワークスペース名・Bot名・チャンネル数・メンバー数を表示
- 失敗: エラー内容と対処法

**Step 4: 完了**
- 自動実行（#oncall-night作成等）の進捗表示
- 完了後「ダッシュボードへ」ボタン

### 5.3 ダッシュボード

**5セクション構成:**

| セクション | 内容 | データソース |
|-----------|------|-------------|
| 統計カード | 総患者数 / HIGH件数 / 本日の報告数 / 未確認アラート数 | GET /api/dashboard |
| 要対応アラート | 未確認のHIGH/MEDアラートカード。クリックで患者詳細へ | alerts配列 |
| 接続ステータス | 各サービス（Slack/Gemini/Firestore等）の接続状態。異常時は赤 | service_status配列 |
| 最近の報告 | 直近10件の報告フィード（患者名・報告者・BPS要約・時刻） | recent_reports配列 |
| 朝レポートプレビュー | 本日の#oncall-night投稿内容のプレビュー | morning_report_preview |

### 5.4 患者一覧

**フィルタ群（AND条件・複数選択可）:**

| フィルタ | UI | 複数選択 |
|---------|-----|---------|
| テキスト検索 | 検索バー（デバウンス付き） | - |
| リスクレベル | タグピル（件数表示） | ○ |
| 事業所 | タグピル | ○ |
| 地区 | タグピル | ○ |
| タグ | タグピル | ○ |
| 疾患 | タグピル | 単一 |

**ソート:** リスクレベル / 更新日 / 名前 / 年齢

**表示モード:**
- リスト表示: フラット一覧
- グループ表示: 事業所別 / 地区別 / リスク別

**患者カード表示項目:** 名前、年齢・性別、基礎疾患（チップ）、リスクレベルバッジ、事業所・地区、最終更新日、タグ

### 5.5 患者登録（/patients/new — 独立ページ）

3ステップフォーム。プログレスインジケータ付き。

**Step 1: 基本情報**
| フィールド | UI | 必須 |
|-----------|-----|------|
| 患者名 | テキスト入力 | ○ |
| フリガナ | テキスト入力 | - |
| 年齢 | 数値入力 | ○ |
| 性別 | M/Fボタン | ○ |
| 基礎疾患 | プリセット9種ワンクリック + カスタム入力 | - |

疾患プリセット: COPD, 高血圧, 2型糖尿病, 心不全, 認知症, CKD, パーキンソン病, 骨粗鬆症, 関節リウマチ

**Step 2: 所属・タグ**
| フィールド | UI |
|-----------|-----|
| 事業所 | ボタン選択（Firestoreマスタから動的取得） |
| 地区 | ボタン選択（Firestoreマスタから動的取得） |
| タグ | 複数選択ボタン（要注意/独居/看取り期/難病） |
| 備考 | テキストエリア |

**Step 3: 担当者・確認**
| フィールド | UI |
|-----------|-----|
| 招待メンバー | メールアドレス/Slack名の追加入力（複数） |
| 確認画面 | 登録内容サマリー + 自動実行処理の説明 |

**登録実行:** プログレス表示で7ステップの自動処理を逐次表示。完了画面でSlackプレビュー。

### 5.6 患者詳細（ドリルダウン）

パンくず: 「患者一覧 > 田中太郎」

**ヘッダー:** 患者名・年齢・性別 / リスクバッジ / 基礎疾患チップ / Slackチャンネルリンク / 編集ボタン

**タブ構成:**

| タブ | 内容 |
|------|------|
| BPSサマリー | Bio/Psycho/Social各軸の構造化データ + ナラティブサマリー。トレンドアイコン付き |
| タイムライン | 全報告の時系列表示。報告者アイコン・日時・BPSタグ・原文プレビュー |
| 推奨事項 | AI生成の推奨アクション一覧。優先度（HIGH/MED/LOW）・BPS軸（Bio/Psycho/Social/Cross）別 |
| アラート履歴 | 当該患者の過去アラート。確認状態・検知パターン・根拠報告 |

**エクスポートボタン:** 3形式選択ドロップダウン → テキスト/Markdown/CSVで出力

### 5.7 アラート一覧

**フィルタ:**
- 緊急度: HIGH / MEDIUM / LOW（タグピル）
- 確認状態: 未確認 / 確認済（トグル）

**アラートカード:**
- 緊急度バッジ + 患者名 + パターン名
- 検知内容サマリー
- 検知日時 + 確認状態
- クリックでアラート詳細モーダル

### 5.8 アラート詳細（モーダル）

- 緊急度 + パターンタイプ + パターン名
- アラートメッセージ全文
- 根拠となった報告（報告者・日時・内容）
- 推奨アクション一覧
- 「確認済みにする」ボタン（確認者名入力）
- 「患者詳細を開く」リンク

### 5.9 ナレッジベース

**5タブ構成:**

| タブ | 内容 |
|------|------|
| 概要 | 統計（ドキュメント数・チャンク数・トークン数）、RAGパイプライン図、カテゴリ別分布 |
| ドキュメント管理 | カテゴリフィルタ、ドキュメントカード（タイトル・ソース・チャンク数・ステータス）、クリックで詳細 |
| チャンク確認 | チャンクサンプル表示、テキスト・トークン数・Embedding状態 |
| 検索テスト | クエリ入力 → 検索実行 → Top-Kチャンク表示（スコア・ソース・カテゴリ） |
| エージェント連携 | 4エージェント × 8カテゴリのバインドマトリクス。トグルで設定変更 |

### 5.10 ナレッジ追加（モーダル）

- カテゴリ選択（8カテゴリのボタン）
- アップロード方式選択: PDF / テキスト直接入力 / URL取込
- ファイルドラッグ&ドロップエリア
- チャンク設定: チャンクサイズ（デフォルト500）/ オーバーラップ（デフォルト50）
- 自動処理の説明: テキスト抽出→チャンキング→Embedding→Vector Search登録

### 5.11 API & サービス設定

**4タブ構成:**

| タブ | 内容 |
|------|------|
| 接続状況 | 統計カード + カテゴリ別サービスカード（AI/ML、外部連携、インフラ）。全接続テストボタン |
| サービス設定 | 各サービスのフィールド一覧。クリックで設定モーダル |
| 使用量 | 月間コスト推移チャート + サービス別API calls/tokens/コスト内訳 |
| セキュリティ | 設定状態確認、セキュリティチェックリスト |

**管理対象6サービス:**

| サービス | 必須 | 主要設定 |
|---------|------|---------|
| Gemini API | ○ | API Key, モデル選択 |
| Vertex AI | ○ | Project ID, リージョン, サービスアカウントJSON |
| Slack | ○ | Bot Token, Signing Secret |
| Firestore | ○ | Project ID, Database ID |
| Cloud Storage | ○ | バケット名, Project ID |
| Speech-to-Text | - | Project ID, 言語（将来機能） |

**サービス個別設定モーダル:** フィールド入力 + 接続テスト + 使用量表示 + 保存

### 5.12 マスタ管理

- 事業所CRUD: 名前・住所
- 地区CRUD: 名前
- タグCRUD: 名前
- インライン編集 or モーダル

### 5.13 組織設定

- 組織名・連絡先編集
- メンバー管理: Admin UIユーザーの招待・権限変更・削除
- ロール: 管理者（全権限） / 医師（閲覧+エクスポート） / 閲覧者（閲覧のみ）

## 6. デザインシステム

### 6.1 カラーパレット

| 用途 | カラー | Hex |
|------|--------|-----|
| 背景 | ダークネイビー | #0a0a0f |
| サーフェス | ダークインディゴ | #12121f |
| カード | ディープブルー | #161628 |
| ボーダー | ダークグレー | #2a2a40 |
| アクセント | ティール | #4ecdc4 |
| 危険 / HIGH | レッド | #ff6b6b |
| 警告 / MEDIUM | イエロー | #ecb22e |
| 成功 / LOW・接続OK | グリーン | #2eb67d |
| 情報 | ブルー | #5b8def |
| テキスト（通常） | ライトグレー | #e8e8ee |
| テキスト（薄） | グレー | #7a7a90 |
| テキスト（ミュート） | ダークグレー | #55556a |

### 6.2 UIコンポーネント（`components/ui/` — 15個）

| コンポーネント | 用途 |
|--------------|------|
| Alert | 通知バナー（成功・警告・エラー・情報） |
| Badge | リスクレベル・ステータス表示（HIGH/MEDIUM/LOWカラーコード） |
| Button | アクションボタン（variant: primary/secondary/danger/ghost） |
| Card | コンテンツコンテナ（StatCard、PatientCard等の基盤） |
| EmptyState | ゼロデータ表示（イラスト+メッセージ+アクションボタン） |
| FormField | フォーム入力ラッパー（ラベル+バリデーションエラー） |
| Input | テキスト入力 |
| Modal | 背景暗転オーバーレイ（ヘッダー+コンテンツ+フッター） |
| Select | ドロップダウン選択 |
| Skeleton | ローディングプレースホルダー |
| Tabs | タブ切替（アクティブ時アクセント色ボーダー下線） |
| TagInput | 複数選択タグ入力（FilterPillパターン） |
| Textarea | テキストエリア |
| Toast | トースト通知 |

### 6.3 レイアウトコンポーネント（`components/layout/` — 7個）

| コンポーネント | 用途 |
|--------------|------|
| AdminLayout | サイドバー+メインエリアのアプリシェル |
| Header | ページタイトル+グローバルアクション |
| Sidebar | ナビゲーションメニュー（セクション分け） |
| SidebarContext | サイドバー状態管理（React Context） |
| NotificationDropdown | リアルタイム通知ドロップダウン |
| SearchModal | グローバル検索モーダル |

### 6.4 データフェッチパターン

SWR 2.4.0ベースのクライアントサイドデータフェッチ。Server Actions不使用。

**カスタムフック:**

| フック | ファイル | 用途 |
|--------|---------|------|
| useAuth | `hooks/useAuth.ts` | Firebase認証状態・ユーザー情報・org_id管理 |
| useApi | `hooks/useApi.ts` | SWRベースのAPI呼び出し（GET/POST/PUT/DELETE） |

**APIクライアント:**
- `lib/api.ts` — Firebase ID Token自動付与のfetchラッパー
- `lib/firebase.ts` — Firebase App/Auth初期化
- `lib/utils.ts` — ユーティリティ関数（日付フォーマット等）
